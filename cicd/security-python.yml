# ============================================================================
# Python Security Scanning Template
# ============================================================================
# Copy this to your project's .github/workflows/security.yml
#
# Right-sized for Python projects (no Docker scanning, no Node.js)
#
# Jobs:
#   1. codeql     â€” GitHub CodeQL static analysis (Python)
#   2. bandit     â€” Python-specific security linter (subprocess, SQL injection, etc.)
#   3. gitleaks   â€” Secret detection across full git history
#   4. sbom       â€” Software Bill of Materials generation
#   5. summary    â€” Aggregated results dashboard
#
# Derived from: security-scan-universal.yml (trimmed for Python-only projects)
# ============================================================================

name: Python Security Scanning

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Mondays at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python
        queries: security-extended,security-and-quality
    
    - name: Autobuild
      uses: github/codeql-action/autobuild@v3
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:python"
        upload: true

  bandit:
    name: Bandit Security Linter
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install Bandit
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]
    
    - name: Run Bandit (JSON output)
      run: |
        bandit -r . -f json -o bandit-report.json --severity-level medium || true
    
    - name: Run Bandit (console output)
      run: |
        bandit -r . -ll
      continue-on-error: true
    
    - name: Upload Bandit results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-report
        path: bandit-report.json
        retention-days: 90

  gitleaks:
    name: GitLeaks Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  sbom:
    name: SBOM Generation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        format: spdx-json
        output-file: sbom-spdx.json
    
    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom-spdx.json
        retention-days: 90

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, bandit, gitleaks, sbom]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "## ðŸ” Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # CodeQL
        if [ "${{ needs.codeql-analysis.result }}" == "success" ]; then
          echo "| ðŸŸ¢ CodeQL | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ”´ CodeQL | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Bandit
        if [ "${{ needs.bandit.result }}" == "success" ]; then
          echo "| ðŸŸ¢ Bandit | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ”´ Bandit | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # GitLeaks
        if [ "${{ needs.gitleaks.result }}" == "success" ]; then
          echo "| ðŸŸ¢ GitLeaks | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ”´ GitLeaks | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # SBOM
        if [ "${{ needs.sbom.result }}" == "success" ]; then
          echo "| ðŸŸ¢ SBOM | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ”´ SBOM | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the Security tab for detailed findings." >> $GITHUB_STEP_SUMMARY
